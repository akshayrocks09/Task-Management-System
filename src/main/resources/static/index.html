<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .auth-section, .task-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .hidden {
            display: none !important;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info span {
            font-weight: 600;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .task-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .task-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .task-card p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .task-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-pending {
            background: #ffc107;
            color: #000;
        }

        .badge-in-progress {
            background: #17a2b8;
            color: white;
        }

        .badge-completed {
            background: #28a745;
            color: white;
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .tasks-grid {
                grid-template-columns: 1fr;
            }

            .task-actions {
                flex-direction: column;
            }

            .btn-secondary {
                margin-left: 0;
                margin-top: 10px;
            }
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üìã Task Management System</h1>
        <p>Manage your tasks efficiently with JWT Authentication</p>
    </div>

    <!-- Alert Messages -->
    <div id="alertContainer"></div>

    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
        <div class="tabs">
            <div class="tab active" onclick="switchAuthTab('login')">Login</div>
            <div class="tab" onclick="switchAuthTab('register')">Register</div>
        </div>

        <!-- Login Form -->
        <div id="loginForm">
            <h2 style="margin-bottom: 20px; color: #333;">Login to Your Account</h2>
            <div class="form-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password" required>
            </div>
            <button onclick="login()">Login</button>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="hidden">
            <h2 style="margin-bottom: 20px; color: #333;">Create New Account</h2>
            <div class="form-group">
                <label for="registerName">Full Name</label>
                <input type="text" id="registerName" placeholder="Enter your full name" required>
            </div>
            <div class="form-group">
                <label for="registerEmail">Email</label>
                <input type="email" id="registerEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">Password</label>
                <input type="password" id="registerPassword" placeholder="Enter password (min 6 characters)" required>
            </div>
            <button onclick="register()">Register</button>
        </div>
    </div>

    <!-- Task Management Section -->
    <div id="taskSection" class="task-section hidden">
        <!-- User Info -->
        <div class="user-info">
            <div>
                <span>üë§ Welcome, </span>
                <span id="userName">User</span>
            </div>
            <button class="btn-danger btn-small" onclick="logout()">Logout</button>
        </div>

        <!-- Add Task Button -->
        <button onclick="openAddTaskModal()">‚ûï Add New Task</button>

        <!-- Tasks Display -->
        <div id="tasksContainer">
            <div class="loader"></div>
        </div>
    </div>
</div>

<!-- Add/Edit Task Modal -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add New Task</h2>
            <button class="close-btn" onclick="closeTaskModal()">√ó</button>
        </div>
        <div class="form-group">
            <label for="taskTitle">Task Title *</label>
            <input type="text" id="taskTitle" placeholder="Enter task title" required>
        </div>
        <div class="form-group">
            <label for="taskDescription">Description</label>
            <textarea id="taskDescription" placeholder="Enter task description"></textarea>
        </div>
        <div class="form-group">
            <label for="taskStatus">Status</label>
            <select id="taskStatus">
                <option value="PENDING">Pending</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="COMPLETED">Completed</option>
            </select>
        </div>
        <button id="saveTaskBtn" onclick="saveTask()">Save Task</button>
        <button class="btn-secondary" onclick="closeTaskModal()">Cancel</button>
    </div>
</div>

<script>
    // Global variables
    let authToken = localStorage.getItem('authToken');
    let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    let editingTaskId = null;

    // API Base URL
    const API_BASE = 'http://localhost:8080/api/v1';

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        if (authToken) {
            showTaskSection();
            loadTasks();
        } else {
            showAuthSection();
        }

        // Add Enter key support for login
        document.getElementById('loginPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
        document.getElementById('registerPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') register();
        });
    });

    // Switch between login and register tabs
    function switchAuthTab(tab) {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const tabs = document.querySelectorAll('.tab');

        tabs.forEach(t => t.classList.remove('active'));

        if (tab === 'login') {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            tabs[0].classList.add('active');
        } else {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            tabs[1].classList.add('active');
        }
    }

    // Show alert message
    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        alertContainer.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Register user
    async function register() {
        const name = document.getElementById('registerName').value;
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;

        if (!name || !email || !password) {
            showAlert('Please fill in all fields', 'error');
            return;
        }

        if (password.length < 6) {
            showAlert('Password must be at least 6 characters', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, email, password })
            });

            const data = await response.json();

            if (response.ok) {
                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                currentUser = { email, name };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                showAlert('Registration successful!');
                showTaskSection();
                loadTasks();
            } else {
                showAlert(data.message || 'Registration failed', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    // Login user
    async function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        if (!email || !password) {
            showAlert('Please fill in all fields', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (response.ok) {
                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                currentUser = { email };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                showAlert('Login successful!');
                showTaskSection();
                loadTasks();
            } else {
                showAlert(data.message || 'Login failed', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    // Logout
    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        authToken = null;
        currentUser = {};
        showAuthSection();
        showAlert('Logged out successfully');
    }

    // Show auth section
    function showAuthSection() {
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('taskSection').classList.add('hidden');
    }

    // Show task section
    function showTaskSection() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('taskSection').classList.remove('hidden');
        document.getElementById('userName').textContent = currentUser.name || currentUser.email || 'User';
    }

    // Load all tasks
    async function loadTasks() {
        const container = document.getElementById('tasksContainer');
        container.innerHTML = '<div class="loader"></div>';

        try {
            const response = await fetch(`${API_BASE}/tasks`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (response.ok) {
                const tasks = await response.json();
                displayTasks(tasks);
            } else if (response.status === 401) {
                showAlert('Session expired. Please login again.', 'error');
                logout();
            } else {
                showAlert('Failed to load tasks', 'error');
                container.innerHTML = '<div class="empty-state">Failed to load tasks</div>';
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
            container.innerHTML = '<div class="empty-state">Error loading tasks</div>';
        }
    }

    // Display tasks
    function displayTasks(tasks) {
        const container = document.getElementById('tasksContainer');

        if (tasks.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 64px; margin-bottom: 20px;">üìù</div>
                    <h3>No tasks yet</h3>
                    <p>Click "Add New Task" to create your first task</p>
                </div>
            `;
            return;
        }

        const tasksHTML = tasks.map(task => `
            <div class="task-card">
                <h3>${escapeHtml(task.title)}</h3>
                <p>${escapeHtml(task.description || 'No description')}</p>
                <div class="task-meta">
                    <span class="badge badge-${task.status.toLowerCase().replace('_', '-')}">${task.status.replace('_', ' ')}</span>
                    <span style="font-size: 12px; color: #999;">Created: ${formatDate(task.createdAt)}</span>
                </div>
                <div class="task-actions">
                    <button class="btn-small btn-success" onclick="editTask('${task.id}')">Edit</button>
                    <button class="btn-small btn-danger" onclick="deleteTask('${task.id}')">Delete</button>
                </div>
            </div>
        `).join('');

        container.innerHTML = `<div class="tasks-grid">${tasksHTML}</div>`;
    }

    // Open add task modal
    function openAddTaskModal() {
        editingTaskId = null;
        document.getElementById('modalTitle').textContent = 'Add New Task';
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDescription').value = '';
        document.getElementById('taskStatus').value = 'PENDING';
        document.getElementById('taskModal').classList.add('show');
    }

    // Edit task
    async function editTask(taskId) {
        try {
            const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (response.ok) {
                const task = await response.json();
                editingTaskId = taskId;
                document.getElementById('modalTitle').textContent = 'Edit Task';
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskModal').classList.add('show');
            } else {
                showAlert('Failed to load task details', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    // Save task (create or update)
    async function saveTask() {
        const title = document.getElementById('taskTitle').value;
        const description = document.getElementById('taskDescription').value;
        const status = document.getElementById('taskStatus').value;

        if (!title || title.length < 3) {
            showAlert('Title must be at least 3 characters', 'error');
            return;
        }

        const taskData = { title, description, status };

        try {
            const url = editingTaskId
                ? `${API_BASE}/tasks/${editingTaskId}`
                : `${API_BASE}/tasks`;

            const method = editingTaskId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(taskData)
            });

            if (response.ok) {
                showAlert(editingTaskId ? 'Task updated successfully!' : 'Task created successfully!');
                closeTaskModal();
                loadTasks();
            } else {
                const error = await response.json();
                showAlert(error.message || 'Failed to save task', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    // Delete task
    async function deleteTask(taskId) {
        if (!confirm('Are you sure you want to delete this task?')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (response.ok) {
                showAlert('Task deleted successfully!');
                loadTasks();
            } else {
                showAlert('Failed to delete task', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    // Close task modal
    function closeTaskModal() {
        document.getElementById('taskModal').classList.remove('show');
        editingTaskId = null;
    }

    // Utility functions
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('taskModal');
        if (event.target === modal) {
            closeTaskModal();
        }
    }
</script>
</body>
</html>